<html>
<head>
	<title>e-Companion Home Network</title>
	<!-- secret: 0IykV9UNRPXzHJxHLDTjDWtP -->
	<link rel="stylesheet" type="text/css" href="css/styles.css">
	<script>
	window.___gcfg = {
		lang: "en-US",
		parsetags: "explicit"
	};
	</script>
	<script src="js/jquery-1.7.2.js"></script>
	<script>
	function initialize() {
		gapi.load("auth2", function() {
			var auth2 = gapi.auth2.init({
				client_id: "1096296309193-hedth2cbhmdmtosu3lqsgc0iro9n23u1.apps.googleusercontent.com",
				cookiepolicy: "single_host_origin"
			});
			if (!auth2.isSignedIn.get()) {
				listenSignedIn(false);
			}
			listenCurrentUser(auth2.currentUser.get());
			auth2.isSignedIn.listen(listenSignedIn);
			auth2.currentUser.listen(listenCurrentUser);
		});
	}

	function listenSignedIn(signedIn) {
		$("#signInButton").text(signedIn ? "" : "Sign in");
		$("#signOutButton").text(signedIn ? "Sign out" : "");
		if (signedIn) {
			tryAppLogin();
		}
	}

	function listenCurrentUser(googleUser) {
		updateProfile(googleUser.getBasicProfile());
	}

	function updateProfile(profile) {
		$("#profileInfo").text(profile ? ("You are: " + profile.getName()) : "");
		$("#disconnectButton").text(profile ? ("Not " + profile.getName() + "?") : ""); 
	}

	function onError(error) {
		console.log(error);
	}

	function disconnect() {
		updateProfile();
		if (gapi.auth2) {
			var auth = gapi.auth2.getAuthInstance();
			auth.disconnect();
		}
	}

	function signIn() {
		if (gapi.auth2) {
			var auth = gapi.auth2.getAuthInstance();
			if (!auth.isSignedIn.get()) {
				auth.signIn();
			}
		}
	}

	function signOut() {
		if (gapi.auth2) {
			var auth = gapi.auth2.getAuthInstance();
			if (auth.isSignedIn.get()) {
				auth.signOut();
			}
		}
	}

	function tryAppLogin() {
		if (gapi.auth2) {
			var auth = gapi.auth2.getAuthInstance();
			var googleUser = auth.currentUser.get();
			if (googleUser) {
				var profile = googleUser.getBasicProfile();
				var googleId = profile.getId();
				var name = profile.getName();
				$.ajax({
					url: "/u",
					data: {
						google_id: googleId,
						name: name
					}
				}).then(function(response) {
					showUser(response.results);
				});
			}
		}
	}

	function showUser(user) {
    $("#content")
      .append(showContactList(user))
  }

  function showContactList(user) {
    var contactList = $("<div>");
		if (!user.contacts || !user.contacts.length) {
			contactList.text("You have no contacts yet.");
		}
		else {
			for (var i = 0; i < user.contacts.length; ++i) {
				contactList.append($("<div>").text(user.contacts[i].contact_name));
			}
		}
    return contactList;
	}

  function showMediaRecorder() {
    var MIME_PRIORITY_LIST = [
      "video/webm, codecs=vp9",
      "video/webm, codecs=vp8",
      "video/webm"
    ]
    var TIME_CHUNK = 1000;
    var BUFFER_LIMIT = 100;

    var ui = $("<div>");
    ui.append($("<div>").text("Media Recorder").css("font-style", "bold"));
    var indicator = $("<div>").css("color", "red").text("initializing...");
    ui.append(indicator);
    var startButton = $("<button>").text("Start recording").hide();
    var stopButton = $("<button>").text("Stop recording").hide();
    ui.append($("<div>").append(startButton).append(stopButton));

    var chunks = [];

    function chooseMimeType() {
      for (var i = 0; i < MIME_PRIORITY_LIST.length; ++i) {
        var mimeType = MIME_PRIORITY_LIST[i];
        if (MediaRecorder.isTypeSupported(mimeType)) {
          return mimeType;
        }
      }
    }

    function initializeUserMedia(successFunc, failFunc) {
      var n = navigator;
      n.getUserMedia = n.getUserMedia || n.webkitGetUserMedia || n.mozGetUserMedia;
      if (n.getUserMedia) {
        var mimeType = chooseMimeType();
        if (mimeType) {
          n.getUserMedia({
            audio: true,
            video: true 
          },
          function(stream) {
            successFunc(stream, mimeType);
          },
          failFunc);
        }
        else {
          failFunc("Video encoding is not supported in your browser.");
        }
      }
      else {
        failFunc("Video recording is not supported in your browser.");
      }
    }

    initializeUserMedia(function(stream, mimeType) {

      var mediaRecorder = new MediaRecorder(stream, {
        mimeType: mimeType
      });

      function showState() {
        indicator.text(mediaRecorder.state);
      }

      function handleDataEvent(event) {
        if (chunks.length == BUFFER_LIMIT) {
          stopRecording();
        }
        else {
          chunks.push(event.data);
        }
      }

      function showVideo() {
        var blob = new Blob(chunks, { type: mimeType });
        var url = window.URL.createObjectURL(blob);
        ui.append($("<div>").append($("<video>").attr("src", url)));
      }

      function startRecording() {
        if (mediaRecorder.state == "inactive") {
          mediaRecorder.ondataavailable = handleDataEvent;
          mediaRecorder.start(TIME_CHUNK);
          showState();
        }
      }

      function stopRecording() {
        if (mediaRecorder.state == "recording") {
          mediaRecorder.ondataavailable = null;
          mediaRecorder.stop();
          showState();
          showVideo();
          chunks = [];
        }
      }

      showState();

      startButton.show().click(startRecording);
      stopButton.show().click(stopRecording);
    },
    function(errmsg) {
      ui.append($("<div>").text("oops -- " + errmsg));
    });

    return ui;
  }

  $(function() {
    $("#content").append(showMediaRecorder());
  });
	</script>
</head>
<body>
<h1>e-Companion Home Network</h1>
<div id="profileInfo"></div>
<div id="disconnectButton" onclick="disconnect();"></div>
<div id="signInButton" onclick="signIn();"></div>
<div id="signOutButton" onclick="signOut();"></div>
<div id="content"></div>
</body>
<script src="https://apis.google.com/js/platform.js?onload=initialize" async defer></script>
</html>
